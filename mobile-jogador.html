<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QUIZ DOS VELOSO - Jogador</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --accent: #FFE66D;
            --purple: #A855F7;
            --blue: #3B82F6;
            --green: #22C55E;
            --orange: #F97316;
            --pink: #EC4899;
            --dark: #1E1B4B;
            --darker: #0F0D24;
            --light: #F8FAFC;
            --gradient-mario: linear-gradient(135deg, #FF6B6B 0%, #FFE66D 50%, #4ECDC4 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--darker);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            color: var(--light);
            overflow-x: hidden;
        }

        html {
            height: -webkit-fill-available;
        }

        /* Background Animation */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: var(--darker);
        }

        .bg-animation::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 30% 70%, rgba(78, 205, 196, 0.2) 0%, transparent 40%),
                radial-gradient(circle at 70% 30%, rgba(255, 107, 107, 0.2) 0%, transparent 40%);
            animation: bgMove 20s ease-in-out infinite;
        }

        @keyframes bgMove {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(-10%, -10%); }
        }

        /* Container */
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Logo */
        .logo-container {
            text-align: center;
            padding: 20px 0;
        }

        .logo {
            font-family: 'Fredoka One', cursive;
            font-size: 2rem;
            background: var(--gradient-mario);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: logoPulse 2s ease-in-out infinite;
        }

        @keyframes logoPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* Screen Management */
        .screen {
            display: none;
            flex: 1;
            animation: slideIn 0.4s ease;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateX(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }

        /* Registration Screen */
        .registration-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 25px;
        }

        .welcome-text {
            text-align: center;
            margin-bottom: 10px;
        }

        .welcome-text h2 {
            font-family: 'Fredoka One', cursive;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .welcome-text p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
        }

        /* Photo Upload */
        .photo-section {
            text-align: center;
        }

        .photo-preview-container {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto 20px;
        }

        .photo-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid var(--accent);
            object-fit: cover;
            background: linear-gradient(135deg, var(--purple), var(--pink));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            box-shadow: 0 10px 40px rgba(255, 230, 109, 0.3);
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            display: none;
        }

        .photo-preview img.visible {
            display: block;
        }

        .photo-preview .placeholder {
            color: white;
        }

        .photo-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-photo {
            padding: 12px 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--light);
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-photo:hover, .btn-photo:active {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--secondary);
            transform: scale(1.02);
        }

        /* Name Input */
        .name-section {
            margin-top: 10px;
        }

        .input-group {
            position: relative;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--accent);
            font-size: 0.9rem;
        }

        .name-input {
            width: 100%;
            padding: 18px 20px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--light);
            font-family: 'Nunito', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s;
        }

        .name-input:focus {
            outline: none;
            border-color: var(--secondary);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 30px rgba(78, 205, 196, 0.3);
        }

        .name-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        /* Join Button */
        .btn-join {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--green), #10B981);
            color: white;
            font-family: 'Fredoka One', cursive;
            font-size: 1.4rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 40px rgba(34, 197, 94, 0.4);
            margin-top: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn-join:hover, .btn-join:active {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 50px rgba(34, 197, 94, 0.5);
        }

        .btn-join:disabled {
            background: #444;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* Waiting Screen */
        .waiting-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 30px;
        }

        .waiting-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid var(--accent);
            object-fit: cover;
            animation: avatarFloat 3s ease-in-out infinite;
        }

        @keyframes avatarFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .waiting-name {
            font-family: 'Fredoka One', cursive;
            font-size: 1.8rem;
            color: var(--light);
        }

        .waiting-message {
            font-size: 1.2rem;
            color: var(--accent);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .waiting-dots {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .waiting-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: var(--secondary);
            animation: dotBounce 1.5s ease-in-out infinite;
        }

        .waiting-dot:nth-child(2) { animation-delay: 0.2s; }
        .waiting-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes dotBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .player-count-box {
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            margin-top: 20px;
        }

        .player-count-number {
            font-family: 'Fredoka One', cursive;
            font-size: 2.5rem;
            color: var(--secondary);
        }

        .player-count-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Game Screen */
        .game-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .question-header {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
        }

        .question-number {
            font-family: 'Fredoka One', cursive;
            font-size: 1.2rem;
            color: var(--accent);
        }

        .progress-container {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-mario);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .question-display {
            flex: 0 0 auto;
            text-align: center;
        }

        .question-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 16px;
            margin-bottom: 15px;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .question-image.visible {
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .question-text {
            font-family: 'Fredoka One', cursive;
            font-size: 1.4rem;
            line-height: 1.4;
            color: var(--light);
            padding: 0 10px;
        }

        /* Answer Options */
        .options-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 10px 0;
        }

        .option-btn {
            width: 100%;
            padding: 20px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--light);
            font-family: 'Nunito', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
            text-align: left;
        }

        .option-btn:hover:not(:disabled), .option-btn:active:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--secondary);
            transform: scale(1.02);
        }

        .option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .option-letter {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--purple), var(--pink));
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Fredoka One', cursive;
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .option-text {
            flex: 1;
        }

        /* Answer Feedback */
        .option-btn.correct {
            background: linear-gradient(135deg, var(--green), #10B981) !important;
            border-color: var(--green) !important;
            animation: correctPulse 0.5s ease;
        }

        .option-btn.incorrect {
            background: linear-gradient(135deg, var(--primary), #DC2626) !important;
            border-color: var(--primary) !important;
            animation: incorrectShake 0.5s ease;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Waiting for next question */
        .waiting-next {
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            margin-top: 20px;
        }

        .waiting-next-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .waiting-next-text {
            font-size: 1.1rem;
            color: var(--accent);
        }

        /* Results Screen */
        .results-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 20px 0;
            gap: 25px;
        }

        .results-position {
            position: relative;
        }

        .position-badge {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Fredoka One', cursive;
            font-size: 3rem;
            color: white;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
            animation: positionReveal 0.8s ease;
        }

        .position-badge.gold {
            background: linear-gradient(135deg, #FFD700, #B8860B);
        }

        .position-badge.silver {
            background: linear-gradient(135deg, #C0C0C0, #808080);
        }

        .position-badge.bronze {
            background: linear-gradient(135deg, #CD7F32, #8B4513);
        }

        .position-badge.other {
            background: linear-gradient(135deg, var(--purple), var(--pink));
        }

        @keyframes positionReveal {
            from { 
                opacity: 0; 
                transform: scale(0) rotate(-180deg); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) rotate(0); 
            }
        }

        .results-message {
            font-family: 'Fredoka One', cursive;
            font-size: 1.8rem;
            background: var(--gradient-mario);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .results-score-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px 40px;
            border-radius: 20px;
            width: 100%;
        }

        .results-score {
            font-family: 'Fredoka One', cursive;
            font-size: 2.5rem;
            color: var(--secondary);
        }

        .results-percentage {
            font-size: 1.2rem;
            color: var(--accent);
            margin-top: 5px;
        }

        /* Mini Ranking */
        .mini-ranking {
            width: 100%;
            margin-top: 20px;
        }

        .mini-ranking-title {
            font-family: 'Fredoka One', cursive;
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--accent);
        }

        .mini-ranking-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .mini-ranking-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .mini-ranking-item.highlight {
            background: rgba(78, 205, 196, 0.2);
            border: 2px solid var(--secondary);
        }

        .mini-ranking-position {
            font-family: 'Fredoka One', cursive;
            font-size: 1.2rem;
            width: 35px;
        }

        .mini-ranking-position.gold { color: #FFD700; }
        .mini-ranking-position.silver { color: #C0C0C0; }
        .mini-ranking-position.bronze { color: #CD7F32; }

        .mini-ranking-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .mini-ranking-name {
            flex: 1;
            text-align: left;
            font-weight: 700;
        }

        .mini-ranking-score {
            font-family: 'Fredoka One', cursive;
            color: var(--secondary);
        }

        /* Confetti */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 12px;
            height: 12px;
            animation: confettiFall 4s linear forwards;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Hidden file inputs */
        .hidden-input {
            display: none;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 13, 36, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--light);
            font-size: 1.1rem;
        }

        /* Error message */
        .error-message {
            background: rgba(220, 38, 38, 0.2);
            border: 2px solid var(--primary);
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            text-align: center;
            display: none;
        }

        .error-message.visible {
            display: block;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>

    <div class="container">
        <!-- Logo -->
        <div class="logo-container">
            <h1 class="logo">‚≠ê QUIZ DOS VELOSO ‚≠ê</h1>
        </div>

        <!-- Registration Screen -->
        <div class="screen active" id="registrationScreen">
            <div class="registration-content">
                <div class="welcome-text">
                    <h2>Bem-vindo! üéÆ</h2>
                    <p>Cadastre-se para participar do quiz</p>
                </div>

                <div class="photo-section">
                    <div class="photo-preview-container">
                        <div class="photo-preview" id="photoPreview">
                            <img src="" alt="" id="photoPreviewImg">
                            <span class="placeholder">üë§</span>
                        </div>
                    </div>
                    <div class="photo-buttons">
                        <button class="btn-photo" onclick="openCamera()">
                            üì∑ Tirar Foto
                        </button>
                        <button class="btn-photo" onclick="openGallery()">
                            üñºÔ∏è Galeria
                        </button>
                    </div>
                    <input type="file" accept="image/*" capture="user" class="hidden-input" id="cameraInput" onchange="handlePhotoSelect(this)">
                    <input type="file" accept="image/*" class="hidden-input" id="galleryInput" onchange="handlePhotoSelect(this)">
                </div>

                <div class="name-section">
                    <div class="input-group">
                        <label class="input-label">Seu Nome</label>
                        <input type="text" class="name-input" id="playerName" placeholder="Digite seu nome" maxlength="20">
                    </div>
                </div>

                <div class="error-message" id="errorMessage">
                    Por favor, digite seu nome para continuar.
                </div>

                <button class="btn-join" id="btnJoin" onclick="joinGame()">
                    üöÄ Entrar no Jogo
                </button>
            </div>
        </div>

        <!-- Waiting Screen -->
        <div class="screen" id="waitingScreen">
            <div class="waiting-content">
                <img class="waiting-avatar" id="waitingAvatar" src="" alt="">
                <div class="waiting-name" id="waitingName">Jogador</div>
                <div class="waiting-message">Aguardando in√≠cio do jogo...</div>
                <div class="waiting-dots">
                    <div class="waiting-dot"></div>
                    <div class="waiting-dot"></div>
                    <div class="waiting-dot"></div>
                </div>
                <div class="player-count-box">
                    <div class="player-count-number" id="waitingPlayerCount">0</div>
                    <div class="player-count-label">jogadores conectados</div>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="screen" id="gameScreen">
            <div class="game-content">
                <div class="question-header">
                    <div class="question-number" id="gameQuestionNumber">Pergunta 1 de 10</div>
                    <div class="progress-container">
                        <div class="progress-fill" id="gameProgress" style="width: 10%"></div>
                    </div>
                </div>

                <div class="question-display">
                    <img class="question-image" id="gameQuestionImage" src="" alt="">
                    <p class="question-text" id="gameQuestionText">Carregando pergunta...</p>
                </div>

                <div class="options-container" id="optionsContainer">
                    <!-- Options will be rendered here -->
                </div>

                <div class="waiting-next" id="waitingNext" style="display: none;">
                    <div class="waiting-next-icon">‚è≥</div>
                    <div class="waiting-next-text">Aguardando pr√≥xima pergunta...</div>
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div class="screen" id="resultsScreen">
            <div class="results-content">
                <div class="results-position">
                    <div class="position-badge" id="positionBadge">1¬∫</div>
                </div>

                <div class="results-message" id="resultsMessage">Parab√©ns!</div>

                <div class="results-score-box">
                    <div class="results-score" id="resultsScore">0 de 10</div>
                    <div class="results-percentage" id="resultsPercentage">0% de acertos</div>
                </div>

                <div class="mini-ranking">
                    <h3 class="mini-ranking-title">üèÜ Ranking</h3>
                    <div class="mini-ranking-list" id="miniRankingList">
                        <!-- Ranking will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Entrando no jogo...</div>
    </div>

    <!-- Confetti Container -->
    <div class="confetti-container" id="confettiContainer"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, push, remove, onValue, update, off } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBWAF9DYI8IFuKSG2tMhFYhDtXcyQI_QoQ",
            authDomain: "quiz-dos-veloso.firebaseapp.com",
            databaseURL: "https://quiz-dos-veloso-default-rtdb.firebaseio.com",
            projectId: "quiz-dos-veloso",
            storageBucket: "quiz-dos-veloso.firebasestorage.app",
            messagingSenderId: "374643522848",
            appId: "1:374643522848:web:221c5f84de4c6bec1a6b45"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        // Global State
        let playerId = null;
        let playerData = null;
        let selectedPhotoFile = null;
        let selectedPhotoDataUrl = null;
        let questions = {};
        let config = {};
        let players = {};
        let currentQuestionKey = null;
        let hasAnswered = false;

        // Check for existing session
        function checkExistingSession() {
            const savedPlayerId = localStorage.getItem('quizPlayerId');
            if (savedPlayerId) {
                // Verify player still exists in database
                get(ref(db, `players/${savedPlayerId}`)).then(snapshot => {
                    if (snapshot.exists()) {
                        playerId = savedPlayerId;
                        playerData = snapshot.val();
                        
                        // Check current game state
                        get(ref(db, 'config')).then(configSnapshot => {
                            const config = configSnapshot.val() || {};
                            
                            if (config.gameEnded) {
                                showScreen('resultsScreen');
                                showResults();
                            } else if (config.gameStarted) {
                                showScreen('gameScreen');
                                setupGameListeners();
                            } else {
                                setupWaitingScreen();
                                showScreen('waitingScreen');
                            }
                        });
                    } else {
                        localStorage.removeItem('quizPlayerId');
                    }
                });
            }
        }

        // Photo handling
        window.openCamera = function() {
            document.getElementById('cameraInput').click();
        };

        window.openGallery = function() {
            document.getElementById('galleryInput').click();
        };

        window.handlePhotoSelect = function(input) {
            if (input.files && input.files[0]) {
                selectedPhotoFile = input.files[0];
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedPhotoDataUrl = e.target.result;
                    const img = document.getElementById('photoPreviewImg');
                    img.src = e.target.result;
                    img.classList.add('visible');
                    document.querySelector('.photo-preview .placeholder').style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        // Join Game
        window.joinGame = async function() {
            const nameInput = document.getElementById('playerName');
            const name = nameInput.value.trim();
            const errorMsg = document.getElementById('errorMessage');
            
            if (!name) {
                errorMsg.classList.add('visible');
                nameInput.focus();
                return;
            }
            
            errorMsg.classList.remove('visible');
            showLoading(true);
            
            try {
                // Generate player ID
                playerId = push(ref(db, 'players')).key;
                
                // Upload photo if selected
                let photoUrl = '';
                if (selectedPhotoFile) {
                    const photoRef = storageRef(storage, `players/${playerId}`);
                    await uploadBytes(photoRef, selectedPhotoFile);
                    photoUrl = await getDownloadURL(photoRef);
                }
                
                // Save player data
                playerData = {
                    name: name,
                    photo: photoUrl || selectedPhotoDataUrl || '',
                    score: 0,
                    answers: []
                };
                
                await set(ref(db, `players/${playerId}`), playerData);
                
                // Save to localStorage
                localStorage.setItem('quizPlayerId', playerId);
                
                // Setup waiting screen
                setupWaitingScreen();
                showLoading(false);
                showScreen('waitingScreen');
                
            } catch (error) {
                console.error('Error joining game:', error);
                showLoading(false);
                alert('Erro ao entrar no jogo. Tente novamente.');
            }
        };

        // Setup Waiting Screen
        function setupWaitingScreen() {
            document.getElementById('waitingAvatar').src = playerData.photo || 
                'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%234ECDC4" width="100" height="100"/><text x="50" y="60" font-size="40" text-anchor="middle" fill="white">üë§</text></svg>';
            document.getElementById('waitingName').textContent = playerData.name;
            
            // Listen for player count
            onValue(ref(db, 'players'), (snapshot) => {
                players = snapshot.val() || {};
                document.getElementById('waitingPlayerCount').textContent = Object.keys(players).length;
            });
            
            // Listen for game start
            onValue(ref(db, 'config'), (snapshot) => {
                config = snapshot.val() || {};
                
                if (config.gameStarted && !config.gameEnded) {
                    showScreen('gameScreen');
                    setupGameListeners();
                } else if (config.gameEnded) {
                    showScreen('resultsScreen');
                    showResults();
                }
            });
        }

        // Setup Game Listeners
        function setupGameListeners() {
            // Listen for questions
            onValue(ref(db, 'questions'), (snapshot) => {
                questions = snapshot.val() || {};
            });
            
            // Listen for config changes (current question)
            onValue(ref(db, 'config'), (snapshot) => {
                config = snapshot.val() || {};
                
                if (config.gameEnded) {
                    showScreen('resultsScreen');
                    showResults();
                    return;
                }
                
                if (config.currentQuestionKey && config.currentQuestionKey !== currentQuestionKey) {
                    currentQuestionKey = config.currentQuestionKey;
                    hasAnswered = false;
                    displayQuestion();
                }
            });
            
            // Listen for players
            onValue(ref(db, 'players'), (snapshot) => {
                players = snapshot.val() || {};
                // Update own player data
                if (players[playerId]) {
                    playerData = players[playerId];
                }
            });
        }

        // Display Question
        function displayQuestion() {
            if (!currentQuestionKey || !questions[currentQuestionKey]) return;
            
            const question = questions[currentQuestionKey];
            const questionIndex = config.currentQuestion || 0;
            const totalQuestions = config.totalQuestions || 10;
            
            document.getElementById('gameQuestionNumber').textContent = 
                `Pergunta ${questionIndex + 1} de ${totalQuestions}`;
            document.getElementById('gameProgress').style.width = 
                `${((questionIndex + 1) / totalQuestions) * 100}%`;
            document.getElementById('gameQuestionText').textContent = question.text;
            
            const imageEl = document.getElementById('gameQuestionImage');
            if (question.image) {
                imageEl.src = question.image;
                imageEl.classList.add('visible');
            } else {
                imageEl.classList.remove('visible');
            }
            
            // Render options
            const optionsContainer = document.getElementById('optionsContainer');
            const letters = ['A', 'B', 'C', 'D'];
            
            optionsContainer.innerHTML = question.options.map((option, index) => `
                <button class="option-btn" onclick="selectAnswer(${index})" data-index="${index}">
                    <div class="option-letter">${letters[index]}</div>
                    <div class="option-text">${option}</div>
                </button>
            `).join('');
            
            // Show options, hide waiting
            optionsContainer.style.display = 'flex';
            document.getElementById('waitingNext').style.display = 'none';
        }

        // Select Answer
        window.selectAnswer = async function(answerIndex) {
            if (hasAnswered) return;
            hasAnswered = true;
            
            const question = questions[currentQuestionKey];
            const isCorrect = answerIndex === question.correct;
            
            // Disable all buttons and show feedback
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach((btn, index) => {
                btn.disabled = true;
                if (index === answerIndex) {
                    btn.classList.add(isCorrect ? 'correct' : 'incorrect');
                }
                if (index === question.correct && !isCorrect) {
                    setTimeout(() => btn.classList.add('correct'), 500);
                }
            });
            
            // Update score in Firebase
            const currentScore = playerData.score || 0;
            const currentAnswers = playerData.answers || [];
            
            await update(ref(db, `players/${playerId}`), {
                score: isCorrect ? currentScore + 1 : currentScore,
                answers: [...currentAnswers, answerIndex]
            });
            
            // Mark as answered
            await set(ref(db, `currentAnswers/${playerId}`), true);
            
            // Show waiting for next question
            setTimeout(() => {
                document.getElementById('optionsContainer').style.display = 'none';
                document.getElementById('waitingNext').style.display = 'block';
            }, 1500);
        };

        // Show Results
        function showResults() {
            // Calculate position
            const sortedPlayers = Object.entries(players)
                .map(([id, player]) => ({
                    id,
                    name: player.name,
                    photo: player.photo,
                    score: player.score || 0
                }))
                .sort((a, b) => b.score - a.score);
            
            const myPosition = sortedPlayers.findIndex(p => p.id === playerId) + 1;
            const myScore = playerData?.score || 0;
            const totalQuestions = config.totalQuestions || Object.keys(questions).length || 10;
            const percentage = totalQuestions > 0 ? Math.round((myScore / totalQuestions) * 100) : 0;
            
            // Position badge
            const badge = document.getElementById('positionBadge');
            badge.textContent = `${myPosition}¬∫`;
            badge.className = 'position-badge';
            if (myPosition === 1) badge.classList.add('gold');
            else if (myPosition === 2) badge.classList.add('silver');
            else if (myPosition === 3) badge.classList.add('bronze');
            else badge.classList.add('other');
            
            // Message based on position
            const messages = [
                'üèÜ Parab√©ns, Campe√£o!',
                'ü•à Quase l√°!',
                'ü•â √ìtimo trabalho!',
                'üëè Muito bem!',
                'üòä Boa tentativa!'
            ];
            document.getElementById('resultsMessage').textContent = 
                messages[Math.min(myPosition - 1, messages.length - 1)];
            
            // Score
            document.getElementById('resultsScore').textContent = `${myScore} de ${totalQuestions}`;
            document.getElementById('resultsPercentage').textContent = `${percentage}% de acertos`;
            
            // Mini ranking
            const rankingList = document.getElementById('miniRankingList');
            rankingList.innerHTML = sortedPlayers.slice(0, 10).map((player, index) => {
                const positionClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                const isMe = player.id === playerId;
                
                return `
                    <div class="mini-ranking-item ${isMe ? 'highlight' : ''}">
                        <div class="mini-ranking-position ${positionClass}">${index + 1}¬∫</div>
                        <img class="mini-ranking-avatar" src="${player.photo || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%234ECDC4%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2260%22 font-size=%2240%22 text-anchor=%22middle%22 fill=%22white%22>üë§</text></svg>'}" alt="">
                        <div class="mini-ranking-name">${player.name}${isMe ? ' (voc√™)' : ''}</div>
                        <div class="mini-ranking-score">${player.score}</div>
                    </div>
                `;
            }).join('');
            
            // Confetti for top 3
            if (myPosition <= 3) {
                createConfetti();
            }
        }

        // Create Confetti
        function createConfetti() {
            const container = document.getElementById('confettiContainer');
            container.innerHTML = '';
            
            const colors = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#A855F7', '#3B82F6', '#22C55E', '#F97316', '#EC4899'];
            const shapes = ['‚ñ†', '‚óè', '‚ñ≤', '‚òÖ'];
            
            for (let i = 0; i < 60; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.textContent = shapes[Math.floor(Math.random() * shapes.length)];
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.color = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.fontSize = (Math.random() * 15 + 8) + 'px';
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 3) + 's';
                container.appendChild(confetti);
            }
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Screen Management
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // Loading
        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('active', show);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkExistingSession();
            
            // Enable join button on name input
            document.getElementById('playerName').addEventListener('input', function() {
                document.getElementById('errorMessage').classList.remove('visible');
            });
            
            // Enter key to join
            document.getElementById('playerName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    joinGame();
                }
            });
        });
    </script>
</body>
</html>
